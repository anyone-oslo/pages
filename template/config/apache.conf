<VirtualHost *:80>
  ServerName <%= @site_domain %>
  ServerAlias www.<%= @site_domain %> <%= @app_name %>.0102.no
  ServerAdmin support@manualdesign.no 
  RailsBaseURI /
  ErrorLog /var/log/apache2/<%= @site_domain %>-error.log
  LogLevel warn
  CustomLog /var/log/apache2/<%= @site_domain %>-access.log combined
  ServerSignature Off

  DocumentRoot /var/www/<%= @app_name %>/current/public
  <Directory "/var/www/<%= @app_name %>/current/public">
    Options FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
    AddType 'application/rss+xml;charset=UTF-8' rss rss;schedule
  </Directory>

  AddDefaultCharset UTF-8

  RewriteEngine On

  # Redirect *.<%= @site_domain.gsub('.', '\.') %> to <%= @site_domain.gsub('.', '\.') %> (to avoid cache duplication)
  #RewriteCond %{HTTP_HOST} ^(www\.<%= @site_domain.gsub('.', '\.') %>$ [NC]
  #RewriteRule ^(.*)$ http://<%= @site_domain.gsub('.', '\.') %>$1 [R=301,L]

  # Check for maintenance file and redirect all requests
  #  ( this is for use with Capistrano's disable_web task )
  RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
  RewriteCond %{SCRIPT_FILENAME} !maintenance.html
  RewriteRule ^.*$ /system/maintenance.html [L]

  # Rewrite index to check for static
  RewriteRule ^/$ /index.html [QSA] 

  # Rewrite to check for Rails cached page
  RewriteRule ^([^.]+)$ $1.html [QSA]

  # Domain based page cache
  RewriteCond %{DOCUMENT_ROOT}/cache/%{HTTP_HOST}/%{REQUEST_FILENAME} -f
  RewriteRule ^/(.*)$ /cache/%{HTTP_HOST}/$1 [PT]

  # Page cache
  RewriteCond %{DOCUMENT_ROOT}/cache/%{REQUEST_FILENAME} -f
  RewriteRule ^/(.*)$ /cache/$1 [PT]
</VirtualHost>
